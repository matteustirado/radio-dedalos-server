<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Gatilho de Check-in (Versão BH)</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #f4f4f9; margin: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; width: 90%; max-width: 700px; }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #status-conexao { font-weight: bold; padding: 5px 10px; border-radius: 5px; color: #fff; }
        .connected { background-color: #28a745; }
        .disconnected { background-color: #dc3545; }
        #log-gatilho { background-color: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; font-family: monospace; min-height: 50px; }
        #lista-perguntas { list-style: none; padding-left: 0; }
        #lista-perguntas li { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        #lista-perguntas img { width: 50px; height: 50px; border-radius: 4px; margin-right: 15px; }
        .loading { color: #888; }
    </style>
</head>
<body>

    <h1>Isolando o Gatilho de Check-in (Versão BH)</h1>

    <div class="container">
        <h2>Status da Conexão (WebSocket)</h2>
        <p>Conectado em: `https://placarbh-cf51a4a5b78a.herokuapp.com/`</p>
        <p>Status: <span id="status-conexao" class="disconnected">Conectando...</span></p>
    </div>
    
    <div class="container">
        <h2>Log de Gatilhos</h2>
        <p>Aguardando o evento "<strong>new_id</strong>" ser disparado pelo servidor de BH...</p>
        <div id="log-gatilho"></div>
    </div>

    <div class="container">
        <h2>Perguntas Recebidas da API (BH)</h2>
        <p>API: `https://dedalosadm2bh-09d55dca461e.herokuapp.com/api/placar/get_perguntas`</p>
        <ul id="lista-perguntas">
            <li class="loading">Aguardando gatilho...</li>
        </ul>
    </div>

    <script>
        // --- Referências do DOM ---
        const displayStatus = document.getElementById('status-conexao');
        const logGatilho = document.getElementById('log-gatilho');
        const listaPerguntas = document.getElementById('lista-perguntas');

        // --- Constantes das APIs e Gatilhos (Versão BH) ---
        const WS_SERVER_BH = 'https://placarbh-cf51a4a5b78a.herokuapp.com/';
        const API_SERVER_BH = 'https://dedalosadm2bh-09d55dca461e.herokuapp.com';
        const TOKEN_BH = '919d97d7df39ecbd0036631caba657221acab99d';

        // --- 3. Função que é chamada DEPOIS do gatilho ---
        async function buscarPerguntasDaEnquete() {
            logGatilho.innerHTML += `Buscando perguntas da API (BH)...<br>`;
            listaPerguntas.innerHTML = '<li class="loading">Buscando perguntas...</li>';

            const url = `${API_SERVER_BH}/api/placar/get_perguntas`;

            try {
                // Estamos usando o fetch() direto, sem proxy, pois vimos que o servidor de admin (dedalosadm2bh...)
                // parece não ter as restrições de CORS.
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Token ${TOKEN_BH}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const dados = await response.json();

                // Limpa a lista
                listaPerguntas.innerHTML = '';

                if (dados.length === 0) {
                    listaPerguntas.innerHTML = '<li>Nenhuma pergunta encontrada na API.</li>';
                    return;
                }

                // Preenche a lista com os resultados
                dados.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<img src="${item.comprovante}" alt="${item.texto}"> ${item.texto}`;
                    listaPerguntas.appendChild(li);
                });

                logGatilho.innerHTML += `Perguntas (BH) carregadas com sucesso!<br>`;

            } catch (error) {
                console.error('Falha ao buscar perguntas (BH):', error);
                listaPerguntas.innerHTML = `<li style="color: red;">Falha ao buscar perguntas. ${error.message}</li>`;
            }
        }


        // --- 2. Lógica do WebSocket (Ouvindo o Gatilho de BH) ---
        const socket = io(WS_SERVER_BH);

        socket.on('connect', () => {
            console.log('Conectado ao servidor WebSocket de BH!');
            displayStatus.textContent = 'Conectado';
            displayStatus.className = 'status connected';
            logGatilho.innerHTML += `Conectado ao WebSocket (BH). Aguardando eventos...<br>`;
        });

        socket.on('disconnect', () => {
            console.log('Desconectado do servidor WebSocket de BH.');
            displayStatus.textContent = 'Desconectado';
            displayStatus.className = 'status disconnected';
            logGatilho.innerHTML += `Desconectado do WebSocket (BH).<br>`;
        });

        // --- ESTE É O GATILHO DE BH ---
        socket.on('new_id', (data) => {
            console.log('GATILHO "new_id" (BH) RECEBIDO!', data);
            
            // Loga a informação recebida (o ID da pulseira)
            const pulseiraId = data.id || 'ID não informado';
            logGatilho.innerHTML = `--------------------------------<br>`;
            logGatilho.innerHTML += `<strong>Gatilho 'new_id' (BH) recebido!</strong><br>`;
            logGatilho.innerHTML += `ID da Pulseira: ${pulseiraId}<br>`;
            logGatilho.innerHTML += `--------------------------------<br>`;

            // Dispara a função para buscar as perguntas na API de BH
            buscarPerguntasDaEnquete();
        });

    </script>
</body>
</html>